# Многошаговые диалоги (Multi-Step Dialogue)

## Описание

Многошаговые диалоги позволяют разделить текст одного диалогового блока на несколько шагов, которые отображаются по очереди при нажатии кнопки "Продолжить". Текст каждого шага накапливается и отображается вместе с предыдущими шагами.

## Синтаксис

```json
{
  "type": "dialogue",
  "id": "unique_id",
  "steps": [
    {
      "text": "Первый текст"
    },
    {
      "text": "Второй текст"
    },
    {
      "text": "Третий текст"
    }
  ]
}
```

## Примеры

### Базовый пример - информационный блок

```json
{
  "type": "dialogue",
  "id": "location_time_info",
  "steps": [
    {
      "text": "<p><b>Местоположение:</b> <s>Нью-Йорк</s></p>"
    },
    {
      "text": "<p><b>Время:</b> 20:52</p>"
    }
  ]
}
```

**Результат:**
1. Первое нажатие "Продолжить" → показывает: `Местоположение: Нью-Йорк`
2. Второе нажатие "Продолжить" → показывает оба текста вместе с `<br>` между ними

### С персонажами

```json
{
  "type": "dialogue",
  "id": "dialogue_sequence",
  "steps": [
    {
      "character": "mc",
      "text": "Кто-то...?"
    },
    {
      "character": "npc",
      "text": "Это я! Помните?"
    },
    {
      "text": "Их голоса эхом отозвались в пустом здании"
    }
  ]
}
```

### С действиями между шагами

```json
{
  "type": "dialogue",
  "id": "dialogue_with_actions",
  "steps": [
    {
      "text": "Первый текст"
    },
    {
      "type": "action",
      "action": "play_sound_effect"
    },
    {
      "text": "Текст после действия"
    }
  ]
}
```

## Поведение

- **Накопление текста**: Каждый новый шаг добавляется к предыдущим с разделителем `<br>`
- **Одновременно видно**: После второго и последующих шагов пользователь видит накопленный текст
- **История**: Каждый шаг сохраняется отдельно в истории
- **Связь**: Все шаги остаются связаны в одном диалоговом блоке (один `stepIndex`)

## Поддержка Typewriter эффекта

При включенном **медленном выводе текста** (Typewriter эффект):

1. **Первый шаг**: Текст печатается посимвольно
2. **Второй и последующие шаги**: 
   - При нажатии "Продолжить" новый текст добавляется к существующему
   - Typewriter эффект **продолжает печать** только нового текста, не переписывая уже напечатанное
   - Уже напечатанный текст остается видимым и неизменным

**Пример:**

```
Шаг 1 напечатан: "Местоположение: Нью-Йорк"
Нажимаем "Продолжить"
Шаг 2 печатается: 
  - Старый текст: "Местоположение: Нью-Йорк" (уже напечатан, не переписывается)
  - Новый текст: "Время: 20:52" (печатается посимвольно)
```

## Обработка в коде

### В `useVisualNovel.js`:

```javascript
// Буфер для накопления текста
const multiStepDialogueBuffer = ref('')

// Отслеживание длины уже напечатанного текста
const multiStepPrintedLength = ref(0)

// При обработке каждого шага
if (multiStepDialogueBuffer.value) {
  multiStepDialogueBuffer.value += '<br>' // Разделитель
}
multiStepDialogueBuffer.value += action.text // Добавляем новый текст

// После нажатия "Продолжить" в многошаговом диалоге
advanceStoryOverride = function() {
  multiStepPrintedLength.value = multiStepDialogueBuffer.value.length // Запоминаем, что этот текст уже напечатан
  // ... переход к следующему шагу
}
```

### В `DialogueBox.vue`:

```javascript
// Получаем информацию о том, сколько текста уже напечатано
const startCharIndex = props.multiStepPrintedLength > 0 ? props.multiStepPrintedLength : 0

// Typewriter начинает печать с этой позиции
typeCharByChar(element, htmlText, plainText, startCharIndex)
```

## Очистка буфера

Буфер автоматически очищается при:
- Завершении всех шагов диалога
- Нажатии "Продолжить" после последнего шага
- Загрузке новой игры (`resetGameState`)
- Восстановлении сохранения (`restoreGameState`)

## Примечания

- Шаги без явного типа (`type`) автоматически обрабатываются как текстовые (`"type": "text"`)
- Можно использовать HTML теги (CSS классы, цвета, размеры и т.д.)
- Разделитель между шагами - `<br>` (можно менять в коде в функции `processDialogueSteps`)
- Максимальное количество шагов не ограничено
- **Typewriter эффект** правильно работает с многошаговыми диалогами, продолжая печать с того места, где она закончилась

